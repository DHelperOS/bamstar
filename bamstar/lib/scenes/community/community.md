[ë°¤ìŠ¤íƒ€] ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ ìƒì„¸ ëª…ì„¸ì„œ
1. í•µì‹¬ ì² í•™ ë° ëª©í‘œ
1.1. ëª©í‘œ
ë©¤ë²„(ìŠ¤íƒ€)ë“¤ì—ê²Œ ê°•ë ¥í•œ ì†Œì†ê°ê³¼ ì •ì„œì  ìœ ëŒ€ë¥¼ ì œê³µí•˜ì—¬, ì±„ìš© í™œë™ì´ ëë‚˜ë„ ì•±ì„ ê³„ì† ì‚¬ìš©í•˜ê²Œ ë§Œë“œëŠ” **'ë– ë‚  ìˆ˜ ì—†ëŠ” ì»¤ë®¤ë‹ˆí‹°'**ë¥¼ êµ¬ì¶•í•œë‹¤.
1.2. í•µì‹¬ ì›ì¹™
ë©¤ë²„(ìŠ¤íƒ€) ì „ìš© ê³µê°„: í”Œë ˆì´ìŠ¤ì˜ ì ‘ê·¼ì„ ì›ì²œì ìœ¼ë¡œ ì°¨ë‹¨í•˜ì—¬, ìŠ¤íƒ€ë“¤ë§Œì˜ **ì™„ë²½í•œ 'ì•ˆì „ì§€ëŒ€'**ë¥¼ ë³´ì¥í•œë‹¤.
ììœ ì™€ ì§ˆì„œì˜ ì¡°í™”: ìŠ¤íƒ€ë“¤ì˜ ììœ ë¡œìš´ í‘œí˜„ì„ ìµœëŒ€í•œ ë³´ì¥í•˜ë˜, ì‹œìŠ¤í…œ(AI)ì´ ë’¤ì—ì„œ ì¡°ìš©íˆ ì§ˆì„œë¥¼ ìœ ì§€í•˜ê³  ì •ë³´ì˜ ê°€ì¹˜ë¥¼ ë†’ì¸ë‹¤.
ì •ë³´ì˜ ê³µê³µì¬í™”: ìŠ¤íƒ€ ê°„ 1:1 ì±„íŒ…ì„ ê¸ˆì§€í•˜ì—¬, ëª¨ë“  ìœ ìš©í•œ ì •ë³´ê°€ ì»¤ë®¤ë‹ˆí‹°ë¼ëŠ” 'ê³µê°œëœ ê´‘ì¥'ì— ì¶•ì ë˜ë„ë¡ í•œë‹¤.
2. ì£¼ìš” ê¸°ëŠ¥ ë° UI/UX ì„¤ê³„
2.1. ë©”ì¸ í”¼ë“œ (Community Home)
UI: ê°œì¸í™”ëœ ì„¸ë¡œ ìŠ¤í¬ë¡¤ í†µí•© í”¼ë“œ.
ì½˜í…ì¸ : êµ¬ë…í•œ #ì±„ë„/ìŠ¤íƒ€ì˜ ê¸€, AI ì¶”ì²œ ê¸€, ì¸ê¸° ê¸€ì´ í˜¼í•© ë…¸ì¶œ.
í•„í„°: í™”ë©´ ìƒë‹¨ì— êµ¬ë… ì±„ë„ ëª©ë¡ì„ 'ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¹©(Chip)' í˜•íƒœë¡œ ì œê³µí•˜ì—¬, íƒ­ìœ¼ë¡œ í”¼ë“œë¥¼ í•„í„°ë§.
ê²Œì‹œê¸€ ì¹´ë“œ:
ëŒ“ê¸€ ì‘ì„±ì ìŠ¤íƒ: ëŒ“ê¸€ ë‹¨ ìŠ¤íƒ€ë“¤ì˜ í”„ë¡œí•„ ì‚¬ì§„ì„ ë™ê·¸ë—ê²Œ ê²¹ì³ ë³´ì´ëŠ” 'ìŠ¤íƒ(Stack)' UIë¡œ ê¸€ì˜ í™œì„±ë„ë¥¼ ì‹œê°í™”.
ìµëª… ê¸€ ì‹œê°ì  êµ¬ë¶„: 'ìµëª… ì „ìš© ì•„ì´ì½˜'ê³¼ ë‹‰ë„¤ì„, ê·¸ë¦¬ê³  ì¹´ë“œ ì¢Œì¸¡ì— 'í‘œì‹œ ë°”'ë¥¼ ë‘ì–´ ëª…í™•íˆ êµ¬ë¶„.
2.2. ê¸€ì“°ê¸° (Create Post)
ì§„ì…ì : í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ì˜ í”Œë¡œíŒ… ì•¡ì…˜ ë²„íŠ¼(FAB).
í•µì‹¬ ê¸°ëŠ¥: ìµëª… ìŠ¤ìœ„ì¹˜
UI: ê¸€ì“°ê¸° ì—ë””í„° í•˜ë‹¨ì˜ ì§ê´€ì ì¸ í† ê¸€ ìŠ¤ìœ„ì¹˜.
ìŠ¤ìœ„ì¹˜ OFF: ë³¸ë˜ ë‹‰ë„¤ì„/í”„ë¡œí•„ë¡œ ê²Œì‹œ. (ì¼ìƒ/ì†Œì…œìš©)
ìŠ¤ìœ„ì¹˜ ON: 'ìµëª…ì˜ ìŠ¤íƒ€'ë¡œ ê²Œì‹œ. (ë¯¼ê° ì •ë³´ ê³µìœ ìš©)
ì²¨ë¶€ ê¸°ëŠ¥: í…ìŠ¤íŠ¸, ì´ë¯¸ì§€(ì—¬ëŸ¬ ì¥) ì²¨ë¶€ ê°€ëŠ¥.
2.3. ëŒ“ê¸€ (Comments)
ê³„ì¸µ êµ¬ì¡°: **ëŒ€ëŒ“ê¸€(Threaded Comments)**ì„ ì§€ì›í•˜ì—¬ ê¹Šì´ ìˆëŠ” ëŒ€í™”ê°€ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„.
ì²¨ë¶€ ê¸°ëŠ¥: í…ìŠ¤íŠ¸ì™€ í•¨ê»˜, **ì´ë¯¸ì§€(1ì¥)**ë¥¼ ì²¨ë¶€í•˜ì—¬ 'ì§¤'ì´ë‚˜ ì¸ì¦ìƒ· ë“±ìœ¼ë¡œ í’ë¶€í•œ ì†Œí†µì´ ê°€ëŠ¥í•˜ë„ë¡ ì§€ì›.
ìƒí˜¸ì‘ìš©: ê°œë³„ ëŒ“ê¸€ì—ë„ **'ì¢‹ì•„ìš”'**ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŒ.
2.4. #í•´ì‹œíƒœê·¸ ì±„ë„ ì‹œìŠ¤í…œ
ì±„ë„ ìë™ ìƒì„±: ìŠ¤íƒ€ê°€ ê¸€ ì‘ì„± ì‹œ, ì¡´ì¬í•˜ì§€ ì•Šë˜ #í•´ì‹œíƒœê·¸ë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ 'ì±„ë„'ì´ ìë™ìœ¼ë¡œ ìƒì„±ë¨.
ìœ ì‚¬ ì±„ë„ ë‚œë¦½ ë°©ì§€ ('ë³´ì´ì§€ ì•ŠëŠ”' ìë™í™”):
AI íƒœê·¸ í†µí•©: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ AIê°€ ìœ ì‚¬ íƒœê·¸ë¥¼ ìë™ìœ¼ë¡œ ê·¸ë£¹í•‘í•˜ê³  **'ëŒ€í‘œ ì±„ë„'**ì„ ì§€ì •.
AI ì„¤ëª… ìƒì„±: AIê°€ ì‹ ê·œ ì±„ë„ì˜ ì´ë¦„ê³¼ ì´ˆê¸° ê²Œì‹œê¸€ ë§¥ë½ì„ ë¶„ì„í•˜ì—¬ 'ì±„ë„ ì„¤ëª…'ì„ ìë™ìœ¼ë¡œ ìƒì„±.
íƒœê·¸ ìë™ì™„ì„±: ê¸€ì“°ê¸° ì‹œ, ì¸ê¸° ìˆëŠ” 'ëŒ€í‘œ ì±„ë„'ì„ ë¨¼ì € ì¶”ì²œí•˜ì—¬ í‘œì¤€í™”ëœ íƒœê·¸ ì‚¬ìš© ìœ ë„.
2.5. ì±„ë„ íƒìƒ‰ (Channel Explorer)
ì§„ì…ì : ì»¤ë®¤ë‹ˆí‹° í™ˆ í—¤ë”ì˜ ğŸ§­ ì•„ì´ì½˜.
UI êµ¬ì„±:
ê²€ìƒ‰ ë°”: ì±„ë„ëª… ì§ì ‘ ê²€ìƒ‰.
ë­í‚¹: ğŸ‘‘ ì§€ê¸ˆ ëœ¨ëŠ” ì±„ë„, ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ìœ¼ë¡œ ë°œê²¬ì˜ ì¬ë¯¸ ì œê³µ.
ì¹´í…Œê³ ë¦¬: AIê°€ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•œ [ğŸ“ ì§€ì—­ ì •ë³´], [ğŸ’¡ ì—…ë¬´ ë…¸í•˜ìš°] ë“±ìœ¼ë¡œ ì²´ê³„ì  íƒìƒ‰.
3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (Supabase/PostgreSQL)
3.1. í…Œì´ë¸” ìƒì„± SQL (Full)
code
SQL
-- ==========[ ì„¹ì…˜ 0: ì‚¬ì „ ì¤€ë¹„ - ê³µìš© ìë™í™” í•¨ìˆ˜ ìƒì„± ]==========
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ==========[ ì„¹ì…˜ 1: ì»¤ë®¤ë‹ˆí‹° í•µì‹¬ í…Œì´ë¸” ìƒì„± ]==========
CREATE TABLE public.community_posts (
  id BIGSERIAL PRIMARY KEY,
  author_id UUID NOT NULL REFERENCES public.users(id) ON DELETE SET NULL,
  content TEXT NOT NULL,
  is_anonymous BOOLEAN NOT NULL DEFAULT false,
  image_urls TEXT[],
  view_count BIGINT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ
);

CREATE TABLE public.community_hashtags (
  id SERIAL PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  description TEXT,
  category TEXT,
  post_count INT NOT NULL DEFAULT 0,
  subscriber_count INT NOT NULL DEFAULT 0,
  last_used_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  parent_hashtag_id INT REFERENCES public.community_hashtags(id) -- ìœ ì‚¬ íƒœê·¸ ê·¸ë£¹í•‘ìš©
);

CREATE TABLE public.post_hashtags (
  post_id BIGINT NOT NULL REFERENCES public.community_posts(id) ON DELETE CASCADE,
  hashtag_id INT NOT NULL REFERENCES public.community_hashtags(id) ON DELETE CASCADE,
  PRIMARY KEY (post_id, hashtag_id)
);

CREATE TABLE public.community_subscriptions (
  id BIGSERIAL PRIMARY KEY,
  subscriber_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  target_hashtag_id INT REFERENCES public.community_hashtags(id) ON DELETE CASCADE,
  target_member_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT unique_subscription_check UNIQUE (subscriber_id, target_hashtag_id, target_member_id),
  CONSTRAINT target_presence_check CHECK (num_nonnulls(target_hashtag_id, target_member_id) = 1)
);

CREATE TABLE public.community_comments (
  id BIGSERIAL PRIMARY KEY,
  post_id BIGINT NOT NULL REFERENCES public.community_posts(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES public.users(id) ON DELETE SET NULL,
  content TEXT, 
  image_url TEXT, 
  is_anonymous BOOLEAN NOT NULL DEFAULT false,
  parent_comment_id BIGINT REFERENCES public.community_comments(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT content_or_image_check CHECK (num_nonnulls(content, image_url) > 0)
);

CREATE TABLE public.community_likes (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  post_id BIGINT REFERENCES public.community_posts(id) ON DELETE CASCADE,
  comment_id BIGINT REFERENCES public.community_comments(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT unique_post_like UNIQUE (user_id, post_id),
  CONSTRAINT unique_comment_like UNIQUE (user_id, comment_id),
  CONSTRAINT target_like_check CHECK (num_nonnulls(post_id, comment_id) = 1)
);

-- ==========[ ì„¹ì…˜ 2: ìë™í™”ë¥¼ ìœ„í•œ í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±° ]==========
-- (ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•œ handle_post_hashtags, trigger_handle_post_hashtags, update_hashtag_subscriber_count ë“± í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±°)

### 3.2. ë°ì´í„°ë² ì´ìŠ¤ í•¨ìˆ˜ (RPC)
```sql
-- ëŒ“ê¸€ ì‘ì„±ì í”„ë¡œí•„ ìŠ¤íƒ ì¡°íšŒë¥¼ ìœ„í•œ DB í•¨ìˆ˜ (users í…Œì´ë¸” ì§ì ‘ ì¡°íšŒ)
CREATE OR REPLACE FUNCTION public.get_post_commenter_avatars(post_id_in BIGINT, limit_in INT)
RETURNS TABLE (profile_img TEXT) LANGUAGE sql STABLE AS $$
  WITH recent_commenters AS (
    SELECT author_id, MAX(created_at) AS last_comment_time
    FROM public.community_comments
    WHERE post_id = post_id_in AND is_anonymous = false
    GROUP BY author_id
    ORDER BY last_comment_time DESC
    LIMIT limit_in
  )
  SELECT u.profile_img
  FROM public.users u
  JOIN recent_commenters rc ON u.id = rc.author_id
  ORDER BY rc.last_comment_time DESC;
$$;

-- Server-side aggregation RPC: return per-post counts for likes and comments
CREATE OR REPLACE FUNCTION public.get_post_counts(post_ids_in BIGINT[])
RETURNS TABLE(post_id BIGINT, likes_count INT, comments_count INT) LANGUAGE sql STABLE AS $$
  SELECT p.id::bigint as post_id,
    COALESCE(l.likes_count, 0) AS likes_count,
    COALESCE(c.comments_count, 0) AS comments_count
  FROM (
    SELECT unnest(post_ids_in) AS id
  ) p
  LEFT JOIN (
    SELECT post_id, COUNT(*)::int AS comments_count
    FROM public.community_comments
    WHERE post_id = ANY(post_ids_in)
    GROUP BY post_id
  ) c ON c.post_id = p.id
  LEFT JOIN (
    SELECT post_id, COUNT(*)::int AS likes_count
    FROM public.community_likes
    WHERE post_id = ANY(post_ids_in)
    GROUP BY post_id
  ) l ON l.post_id = p.id;
$$;

-- Returns post_ids the current authenticated user has liked from the provided list
CREATE OR REPLACE FUNCTION public.get_user_liked_posts(post_ids_in BIGINT[])
RETURNS TABLE(post_id BIGINT) LANGUAGE sql STABLE AS $$
  SELECT post_id
  FROM public.community_likes
  WHERE user_id = auth.uid() AND post_id = ANY(post_ids_in);
$$;

-- Increment view_count for a post and return the new count
CREATE OR REPLACE FUNCTION public.increment_post_view(post_id_in BIGINT)
RETURNS TABLE(new_count BIGINT) LANGUAGE sql VOLATILE AS $$
  UPDATE public.community_posts
  SET view_count = view_count + 1
  WHERE id = post_id_in
  RETURNING view_count AS new_count;
$$;

-- -----------------------------------------------------------------------------
-- Server-side ranking RPC: get_top_posts_by_metric
-- -----------------------------------------------------------------------------
-- ì„¤ëª…:
-- "ì¸ê¸° ìˆœ"(comments ê¸°ì¤€) ë˜ëŠ” "ì¢‹ì•„ìš” ìˆœ"(likes ê¸°ì¤€) ì •ë ¬ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ
-- í˜ì´ì§€ë„¤ì´ì…˜í•˜ë©´ì„œ ì •í™•í•˜ê²Œ êµ¬í˜„í•˜ë ¤ë©´ DBì—ì„œ ì§‘ê³„Â·ì •ë ¬ëœ ê²°ê³¼ë¥¼ ì§ì ‘ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
-- ì•„ë˜ RPCëŠ” ì£¼ì–´ì§„ ìµœê·¼ ìœˆë„ìš°(ì˜ˆ: 7ì¼) ë‚´ì˜ ê²Œì‹œê¸€ì„ metric( 'comments' | 'likes' ) ìœ¼ë¡œ
-- ì •ë ¬í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤. ë°˜í™˜ê°’ì—ëŠ” likes_count, comments_count í•„ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
-- ì‚¬ìš© ì˜ˆ:
-- SELECT * FROM public.get_top_posts_by_metric(7, 'comments', 20, 0);
-- SELECT * FROM public.get_top_posts_by_metric(7, 'likes', 20, 0);

-- ê¶Œì¥ ì¸ë±ìŠ¤:
-- - community_comments(post_id, created_at)
-- - community_likes(post_id, created_at)
-- - community_posts(created_at)
-- ì´ëŸ¬í•œ ì¸ë±ìŠ¤ë“¤ì€ ìœˆë„ìš° ê¸°ë°˜ í•„í„°ë§(ìµœê·¼ Nì¼)ê³¼ ì§‘ê³„ ì¿¼ë¦¬ë¥¼ ê°€ì†í™”í•©ë‹ˆë‹¤.

4. ë³´ì•ˆ (Row Level Security)
4.1. RLS ì •ì±… SQL
code
SQL
-- ê²Œì‹œê¸€ (community_posts)
ALTER TABLE public.community_posts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow read access to authenticated users" ON public.community_posts FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow users to manage their own posts" ON public.community_posts FOR INSERT, UPDATE, DELETE USING (auth.uid() = author_id);

-- ëŒ“ê¸€ (community_comments)
ALTER TABLE public.community_comments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow read access to authenticated users" ON public.community_comments FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow users to manage their own comments" ON public.community_comments FOR INSERT, UPDATE, DELETE USING (auth.uid() = author_id);

-- ê³µê°/ì¢‹ì•„ìš” (community_likes)
ALTER TABLE public.community_likes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow read access to authenticated users" ON public.community_likes FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow users to manage their own likes" ON public.community_likes FOR INSERT, DELETE USING (auth.uid() = user_id);

-- êµ¬ë… (community_subscriptions)
ALTER TABLE public.community_subscriptions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow users to read their own subscriptions" ON public.community_subscriptions FOR SELECT USING (auth.uid() = subscriber_id);
CREATE POLICY "Allow users to manage their own subscriptions" ON public.community_subscriptions FOR INSERT, DELETE USING (auth.uid() = subscriber_id);

-- #í•´ì‹œíƒœê·¸ í…Œì´ë¸” (ì½ê¸° ì „ìš©)
ALTER TABLE public.community_hashtags ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow read access to all users" ON public.community_hashtags FOR SELECT USING (true);

-- 1. íŠ¸ë¦¬ê±°ê°€ í˜¸ì¶œí•  'í•¨ìˆ˜'ë¥¼ ë¨¼ì € ìƒì„±í•©ë‹ˆë‹¤.
--    ì´ í•¨ìˆ˜ì˜ ì—­í• ì€ ì˜¤ì§ 'ê¸°ë³¸ ì±„ë„ êµ¬ë…' ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒ í•˜ë‚˜ë¿ì…ë‹ˆë‹¤.
CREATE OR REPLACE FUNCTION public.subscribe_default_channels_on_signup()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- ì‹ ê·œ ì‚¬ìš©ì(NEW.id)ê°€ '8ë²ˆ' ì±„ë„ì„ êµ¬ë…í•˜ë„ë¡ INSERT
  INSERT INTO public.community_subscriptions (subscriber_id, target_hashtag_id)
  VALUES (NEW.id, 8);
  
  -- (ë§Œì•½ 9ë²ˆ ì±„ë„ë„ ê¸°ë³¸ êµ¬ë…ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì¤„ì˜ ì£¼ì„ì„ í‘¸ì„¸ìš”)
  -- INSERT INTO public.community_subscriptions (subscriber_id, target_hashtag_id)
  -- VALUES (NEW.id, 9);

  RETURN NEW;
END;
$$;

COMMENT ON FUNCTION public.subscribe_default_channels_on_signup() IS 'ì‹ ê·œ ê°€ì… ì‹œ, ì‚¬ìš©ìë¥¼ ë¯¸ë¦¬ ì§€ì •ëœ ê¸°ë³¸ ì»¤ë®¤ë‹ˆí‹° ì±„ë„ì— ìë™ìœ¼ë¡œ êµ¬ë…ì‹œí‚µë‹ˆë‹¤.';


-- 2. 'íŠ¸ë¦¬ê±°'ë¥¼ ìƒì„±í•˜ì—¬ ìœ„ í•¨ìˆ˜ì™€ Supabase ì¸ì¦ ì‹œìŠ¤í…œì„ ì—°ê²°í•©ë‹ˆë‹¤.
--    ì´ íŠ¸ë¦¬ê±°ëŠ” 'auth.users' í…Œì´ë¸”ì— ìƒˆë¡œìš´ í–‰ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì‘ë™í•©ë‹ˆë‹¤.

-- (í˜¹ì‹œ ëª¨ë¥¼ ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ê°™ì€ ì´ë¦„ì˜ ê¸°ì¡´ íŠ¸ë¦¬ê±°ê°€ ìˆë‹¤ë©´ ë¨¼ì € ì‚­ì œí•©ë‹ˆë‹¤)
DROP TRIGGER IF EXISTS on_auth_user_created_subscribe_default ON auth.users;

CREATE TRIGGER on_auth_user_created_subscribe_default
  AFTER INSERT ON auth.users -- 'auth.users' í…Œì´ë¸”ì—
  FOR EACH ROW               -- ìƒˆë¡œìš´ í–‰ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤
  EXECUTE PROCEDURE public.subscribe_default_channels_on_signup(); -- ìœ„ì—ì„œ ë§Œë“  í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œë¼.




  -- 1ë‹¨ê³„: ê¸°ì¡´ì˜ ë³µí•© ê¸°ë³¸í‚¤(Primary Key) ì œì•½ì¡°ê±´ì„ ë¨¼ì € ì œê±°í•©ë‹ˆë‹¤.
-- (Supabaseê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ì´ë¦„ì€ ë³´í†µ 'community_likes_pkey' ì…ë‹ˆë‹¤.)
ALTER TABLE public.community_likes
  DROP CONSTRAINT IF EXISTS community_likes_pkey;


-- 2ë‹¨ê³„: ê° 'ì¢‹ì•„ìš”' í–‰ìœ„ë¥¼ ìœ„í•œ ê³ ìœ  ID ì»¬ëŸ¼(id)ì„ ì¶”ê°€í•˜ê³ , ì´ë¥¼ ìƒˆë¡œìš´ ê¸°ë³¸í‚¤ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
-- (IF NOT EXISTS êµ¬ë¬¸ìœ¼ë¡œ, ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì˜¤ë¥˜ ì—†ì´ ë„˜ì–´ê°‘ë‹ˆë‹¤.)
ALTER TABLE public.community_likes
  ADD COLUMN IF NOT EXISTS id BIGSERIAL PRIMARY KEY;


-- 3ë‹¨ê³„: ëŒ“ê¸€ì„ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” comment_id ì»¬ëŸ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
ALTER TABLE public.community_likes
  ADD COLUMN IF NOT EXISTS comment_id BIGINT REFERENCES public.community_comments(id) ON DELETE CASCADE;


-- 4ë‹¨ê³„: post_id ì»¬ëŸ¼ì´ ë” ì´ìƒ í•­ìƒ ê°’ì´ ìˆì„ í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ, NOT NULL ì œì•½ì¡°ê±´ì„ ì œê±°í•©ë‹ˆë‹¤.
ALTER TABLE public.community_likes
  ALTER COLUMN post_id DROP NOT NULL;


-- 5ë‹¨ê³„: ìƒˆë¡œìš´ ê·œì¹™ì„ ì ìš©í•˜ê¸° ìœ„í•œ ì œì•½ì¡°ê±´(Constraint)ë“¤ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
-- (ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´, ê¸°ì¡´ì— ê°™ì€ ì´ë¦„ì˜ ì œì•½ì¡°ê±´ì´ ìˆë‹¤ë©´ ë¨¼ì € ì‚­ì œí•©ë‹ˆë‹¤.)
ALTER TABLE public.community_likes
  DROP CONSTRAINT IF EXISTS unique_post_like,
  DROP CONSTRAINT IF EXISTS unique_comment_like,
  DROP CONSTRAINT IF EXISTS target_like_check;

-- ì œì•½ì¡°ê±´ 5.1: í•œ ì‚¬ëŒì´ ê°™ì€ 'ê²Œì‹œê¸€'ì— ì¤‘ë³µìœ¼ë¡œ ì¢‹ì•„ìš” ëˆ„ë¥´ëŠ” ê²ƒì„ ë°©ì§€
ALTER TABLE public.community_likes
  ADD CONSTRAINT unique_post_like UNIQUE (user_id, post_id);

-- ì œì•½ì¡°ê±´ 5.2: í•œ ì‚¬ëŒì´ ê°™ì€ 'ëŒ“ê¸€'ì— ì¤‘ë³µìœ¼ë¡œ ì¢‹ì•„ìš” ëˆ„ë¥´ëŠ” ê²ƒì„ ë°©ì§€
ALTER TABLE public.community_likes
  ADD CONSTRAINT unique_comment_like UNIQUE (user_id, comment_id);

-- ì œì•½ì¡°ê±´ 5.3: 'ì¢‹ì•„ìš”'ì˜ ëŒ€ìƒì€ ê²Œì‹œê¸€ ë˜ëŠ” ëŒ“ê¸€, ë‘˜ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•¨ì„ ê°•ì œ
ALTER TABLE public.community_likes
  ADD CONSTRAINT target_like_check CHECK (num_nonnulls(post_id, comment_id) = 1);


-- 6ë‹¨ê³„: RLS ì •ì±…ì„ ìƒˆë¡œìš´ êµ¬ì¡°ì— ë§ê²Œ ë‹¤ì‹œ ì •ì˜í•©ë‹ˆë‹¤.
-- (ê¸°ì¡´ ì •ì±…ë“¤ì„ ì•ˆì „í•˜ê²Œ ì‚­ì œí•˜ê³ , ì˜¬ë°”ë¥¸ ë¬¸ë²•ìœ¼ë¡œ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤.)
DROP POLICY IF EXISTS "Allow read access to authenticated users" ON public.community_likes;
DROP POLICY IF EXISTS "Allow users to manage their own likes" ON public.community_likes;
DROP POLICY IF EXISTS "Allow users to insert their own likes" ON public.community_likes;
DROP POLICY IF EXISTS "Allow users to delete their own likes" ON public.community_likes;

CREATE POLICY "Allow read access to authenticated users" ON public.community_likes FOR SELECT USING (auth.role() = 'authenticated');
CREATE POLICY "Allow users to insert their own likes" ON public.community_likes FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Allow users to delete their own likes" ON public.community_likes FOR DELETE USING (auth.uid() = user_id);


-- 7ë‹¨ê³„: í…Œì´ë¸”ê³¼ ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„(Comment)ì„ ì—…ë°ì´íŠ¸í•˜ì—¬, ìƒˆë¡œìš´ êµ¬ì¡°ë¥¼ ëª…í™•íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
COMMENT ON TABLE public.community_likes IS 'ë©¤ë²„ê°€ ê²Œì‹œê¸€ ë˜ëŠ” ëŒ“ê¸€ì— ëˆ„ë¥¸ ê³µê°(ì¢‹ì•„ìš”) ì •ë³´. (ëŒ“ê¸€ ì¢‹ì•„ìš” ì§€ì›)';
COMMENT ON COLUMN public.community_likes.post_id IS 'ì¢‹ì•„ìš” ëŒ€ìƒ (ê²Œì‹œê¸€ ID). ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° NULL.';
COMMENT ON COLUMN public.community_likes.comment_id IS 'ì¢‹ì•„ìš” ëŒ€ìƒ (ëŒ“ê¸€ ID). ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° NULL.';


CREATE TABLE public.community_likes (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  
  -- 'ì¢‹ì•„ìš”'ì˜ ëŒ€ìƒì€ post ë˜ëŠ” comment ë‘˜ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.
  post_id BIGINT REFERENCES public.community_posts(id) ON DELETE CASCADE,
  comment_id BIGINT REFERENCES public.community_comments(id) ON DELETE CASCADE,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- ì œì•½ì¡°ê±´ 1: í•œ ì‚¬ëŒì´ ê°™ì€ 'ê²Œì‹œê¸€'ì— ì¤‘ë³µìœ¼ë¡œ ì¢‹ì•„ìš” ëˆ„ë¥´ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
  CONSTRAINT unique_post_like UNIQUE (user_id, post_id),

  -- ì œì•½ì¡°ê±´ 2: í•œ ì‚¬ëŒì´ ê°™ì€ 'ëŒ“ê¸€'ì— ì¤‘ë³µìœ¼ë¡œ ì¢‹ì•„ìš” ëˆ„ë¥´ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
  CONSTRAINT unique_comment_like UNIQUE (user_id, comment_id),

  -- ì œì•½ì¡°ê±´ 3: 'ì¢‹ì•„ìš”'ì˜ ëŒ€ìƒì€ ê²Œì‹œê¸€ ë˜ëŠ” ëŒ“ê¸€, ë‘˜ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•¨ì„ ê°•ì œí•©ë‹ˆë‹¤.
  CONSTRAINT target_like_check CHECK (num_nonnulls(post_id, comment_id) = 1)
);


-- 2. í…Œì´ë¸” ë° ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„(Comment) ì¶”ê°€
COMMENT ON TABLE public.community_likes IS 'ë©¤ë²„ê°€ ê²Œì‹œê¸€ ë˜ëŠ” ëŒ“ê¸€ì— ëˆ„ë¥¸ ê³µê°(ì¢‹ì•„ìš”) ì •ë³´.';
COMMENT ON COLUMN public.community_likes.post_id IS 'ì¢‹ì•„ìš” ëŒ€ìƒ (ê²Œì‹œê¸€ ID). ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° NULL.';
COMMENT ON COLUMN public.community_likes.comment_id IS 'ì¢‹ì•„ìš” ëŒ€ìƒ (ëŒ“ê¸€ ID). ê²Œì‹œê¸€ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²½ìš° NULL.';


-- 3. RLS (Row Level Security) í™œì„±í™” ë° ì •ì±… ì •ì˜
ALTER TABLE public.community_likes ENABLE ROW LEVEL SECURITY;

-- ì •ì±… 3.1: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ëª¨ë“  ì¢‹ì•„ìš” ì •ë³´ë¥¼ 'ì½ì„(SELECT)' ìˆ˜ ìˆìŠµë‹ˆë‹¤.
CREATE POLICY "Allow read access to authenticated users"
  ON public.community_likes
  FOR SELECT
  USING (auth.role() = 'authenticated');

-- ì •ì±… 3.2: ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì¢‹ì•„ìš”ë§Œ 'ëˆ„ë¥¼(INSERT)' ìˆ˜ ìˆìŠµë‹ˆë‹¤.
CREATE POLICY "Allow users to insert their own likes"
  ON public.community_likes
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ì •ì±… 3.3: ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì¢‹ì•„ìš”ë§Œ 'ì·¨ì†Œ(DELETE)'í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
CREATE POLICY "Allow users to delete their own likes"
  ON public.community_likes
  FOR DELETE
  USING (auth.uid() = user_id);