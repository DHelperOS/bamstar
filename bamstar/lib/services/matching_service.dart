import 'package:supabase_flutter/supabase_flutter.dart';
import '../scenes/matching/models/match_profile.dart';

/// Enhanced matching service with full role-based UI support
class MatchingService {
  static final _supabase = Supabase.instance.client;
  
  /// Get matching profiles using Edge Functions (Enhanced)
  static Future<List<MatchProfile>> getMatchingProfiles({
    required bool isMemberView,
    int limit = 20,
    int offset = 0,
    int minScore = 60,
  }) async {
    try {
      final currentUser = _supabase.auth.currentUser;
      if (currentUser == null) {
        throw Exception('User not authenticated');
      }

      // Call match-finder Edge Function
      final response = await _supabase.functions.invoke(
        'match-finder',
        body: {
          'userId': currentUser.id,
          'userType': isMemberView ? 'member' : 'place',
          'limit': limit,
          'offset': offset,
          'minScore': minScore,
        },
      );

      if (response.status != 200) {
        throw Exception('Failed to fetch matches: ${response.data}');
      }

      final responseData = response.data as Map<String, dynamic>;
      final matches = responseData['matches'] as List<dynamic>? ?? [];

      // Process matches with enhanced profile data
      final profileFutures = matches.map<Future<MatchProfile>>((matchData) async {
        return await _convertToMatchProfile(matchData, isMemberView);
      });

      return await Future.wait(profileFutures);

    } catch (e) {
      // Fallback to direct database query if Edge Function fails
      return await _getFallbackProfiles(
        isMemberView: isMemberView,
        limit: limit,
      );
    }
  }

  /// Convert match data from Edge Function to MatchProfile (Enhanced)
  static Future<MatchProfile> _convertToMatchProfile(Map<String, dynamic> matchData, bool isMemberView) async {
    final profile = isMemberView 
        ? matchData['place'] as Map<String, dynamic>? ?? {}
        : matchData['member'] as Map<String, dynamic>? ?? {};
    
    final profileData = isMemberView 
        ? profile['place_profile'] as Map<String, dynamic>? ?? {}
        : profile['member_profile'] as Map<String, dynamic>? ?? {};

    final matchScore = (matchData['total_score'] as num?)?.round() ?? 0;
    final userId = profile['id'] ?? '';
    
    if (isMemberView) {
      // Member sees Place profiles
      final heartsCount = await _getHeartsCount(userId, 'place');
      final favoritesCount = await _getFavoritesCount(userId, 'place');
      
      return MatchProfile(
        id: userId,
        name: profileData['place_name'] ?? 'Ïïå Ïàò ÏóÜÎäî ÏóÖÏ≤¥',
        subtitle: _formatIndustries(profile['place_industries']),
        imageUrl: _getFirstImageUrl(profileData['profile_image_urls']),
        matchScore: matchScore,
        location: _extractLocation(profileData['address']),
        distance: _calculateDistanceFromCoords(
          profileData['latitude'],
          profileData['longitude'],
        ),
        payInfo: _formatPayInfo(
          profileData['offered_min_pay'],
          profileData['offered_max_pay'],
        ),
        schedule: _formatSchedule(profileData),
        tags: _generatePlaceTagsFromProfile(profileData, profile),
        type: ProfileType.place,
        isVerified: profileData['is_verified'] == true,
        isPremium: profileData['is_premium'] == true,
        hasSentHeart: matchData['has_sent_heart'] == true,
        isFavorited: matchData['is_favorited'] == true,
        heartsCount: heartsCount,
        favoritesCount: favoritesCount,
        industries: _extractIndustriesList(profile['place_industries']),
      );
    } else {
      // Place sees Member profiles (Ï£ºÏöî ÏàòÏ†ï Î∂ÄÎ∂Ñ)
      final heartsCount = await _getHeartsCount(userId, 'member');
      final favoritesCount = await _getFavoritesCount(userId, 'member');
      
      return MatchProfile(
        id: userId,
        name: profileData['real_name'] ?? 'Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê',
        subtitle: _formatMemberIndustries(profile['member_industries']), // ÏßÄÏõê ÏóÖÏ¢ÖÏúºÎ°ú Î≥ÄÍ≤Ω
        imageUrl: _getFirstImageUrl(profileData['profile_image_urls']),
        matchScore: matchScore,
        location: _formatMemberAreas(profile['member_areas']), // Ìù¨ÎßùÏßÄÏó≠ÏúºÎ°ú Î≥ÄÍ≤Ω
        distance: _calculateDistanceFromCoords(
          profileData['latitude'],
          profileData['longitude'],
        ),
        payInfo: (profileData['desired_pay_amount'] != null && profileData['desired_pay_amount'] > 0) 
            ? '${_formatPayType(profileData['desired_pay_type'])} ${_formatCurrency(profileData['desired_pay_amount'])}Ïõê'
            : 'Í∏âÏó¨ ÌòëÏùò',
        schedule: _formatMemberSchedule(profileData['desired_working_days']),
        tags: _generateMemberTagsFromProfile(profileData, profile),
        type: ProfileType.member,
        isVerified: profileData['is_verified'] == true,
        isPremium: profileData['is_premium'] == true,
        hasSentHeart: matchData['has_sent_heart'] == true,
        isFavorited: matchData['is_favorited'] == true,
        gender: profileData['gender'], // ÏÑ±Î≥Ñ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        heartsCount: heartsCount,
        favoritesCount: favoritesCount,
        industries: _extractIndustriesList(profile['member_industries']),
        preferredAreas: _extractAreasList(profile['member_areas']),
        experienceLevel: profileData['experience_level'], // Í≤ΩÎ†• Î†àÎ≤® Ï∂îÍ∞Ä
      );
    }
  }

  /// Format member industries from join data
  static String _formatMemberIndustries(List<dynamic>? industries) {
    if (industries == null || industries.isEmpty) {
      return 'ÏóÖÏ¢Ö ÎØ∏Ï†ï';
    }
    
    final industryNames = industries
        .where((industry) => 
            industry['attributes'] != null && 
            industry['attributes']['type'] == 'INDUSTRY')
        .map((industry) => industry['attributes']['name'] as String)
        .toList();
    
    if (industryNames.isEmpty) {
      return 'ÏóÖÏ¢Ö ÎØ∏Ï†ï';
    }
    
    return industryNames.join('‚Ä¢');
  }

  /// Format member preferred areas (top 2 priorities)
  static String _formatMemberAreas(List<dynamic>? areas) {
    if (areas == null || areas.isEmpty) {
      return 'ÏÑ†Ìò∏ÏßÄÏó≠ ÏóÜÏùå';
    }
    
    final areaNames = areas
        .where((area) => area['area_groups'] != null)
        .map((area) => area['area_groups']['name'] as String)
        .take(2) // Only show top 2 priorities
        .toList();
    
    if (areaNames.isEmpty) {
      return 'ÏÑ†Ìò∏ÏßÄÏó≠ ÏóÜÏùå';
    }
    
    return areaNames.join('‚Ä¢');
  }

  /// Format place industries from join data
  static String _formatIndustries(List<dynamic>? industries) {
    if (industries == null || industries.isEmpty) {
      return 'ÏóÖÏ¢Ö Ï†ïÎ≥¥ ÏóÜÏùå';
    }
    
    final industryNames = industries
        .where((industry) => 
            industry['attributes'] != null && 
            industry['attributes']['type'] == 'INDUSTRY')
        .map((industry) => industry['attributes']['name'] as String)
        .toList();
    
    if (industryNames.isEmpty) {
      return 'ÏóÖÏ¢Ö Ï†ïÎ≥¥ ÏóÜÏùå';
    }
    
    // Primary industry first, then others
    industryNames.sort((a, b) {
      final aIsPrimary = industries.any((industry) => 
          industry['attributes']['name'] == a && 
          industry['is_primary'] == true);
      final bIsPrimary = industries.any((industry) => 
          industry['attributes']['name'] == b && 
          industry['is_primary'] == true);
      
      if (aIsPrimary && !bIsPrimary) return -1;
      if (!aIsPrimary && bIsPrimary) return 1;
      return a.compareTo(b);
    });
    
    return industryNames.join('‚Ä¢');
  }

  /// Extract industries list
  static List<String> _extractIndustriesList(List<dynamic>? industries) {
    if (industries == null) return [];
    
    return industries
        .where((industry) => 
            industry['attributes'] != null && 
            industry['attributes']['type'] == 'INDUSTRY')
        .map((industry) => industry['attributes']['name'] as String)
        .toList();
  }

  /// Extract member preferred areas list
  static List<String> _extractAreasList(List<dynamic>? areas) {
    if (areas == null) return [];
    
    return areas
        .where((area) => area['area_groups'] != null)
        .map((area) => area['area_groups']['name'] as String)
        .take(2) // Only top 2 priorities
        .toList();
  }

  /// Get hearts count for user
  static Future<int> _getHeartsCount(String userId, String userType) async {
    try {
      final table = userType == 'member' ? 'member_hearts' : 'place_hearts';
      final column = userType == 'member' ? 'member_user_id' : 'place_user_id';
      
      final response = await _supabase
          .from(table)
          .select('*')
          .eq(column, userId);
          
      return response.length;
    } catch (e) {
      return 0;
    }
  }

  /// Get favorites count for user
  static Future<int> _getFavoritesCount(String userId, String userType) async {
    try {
      final table = userType == 'member' ? 'member_favorites' : 'place_favorites';
      final column = userType == 'member' ? 'member_user_id' : 'place_user_id';
      
      final response = await _supabase
          .from(table)
          .select('*')
          .eq(column, userId);
          
      return response.length;
    } catch (e) {
      return 0;
    }
  }

  /// Generate member tags from profile data
  static List<String> _generateMemberTagsFromProfile(Map<String, dynamic> profileData, Map<String, dynamic> profile) {
    List<String> tags = [];
    
    // DEBUG: Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
    print('üè∑Ô∏è [TAG DEBUG] profileData keys: ${profileData.keys.toList()}');
    print('üè∑Ô∏è [TAG DEBUG] profile keys: ${profile.keys.toList()}');
    print('üè∑Ô∏è [TAG DEBUG] member_attributes: ${profile['member_attributes']}');
    print('üè∑Ô∏è [TAG DEBUG] member_preferences: ${profile['member_preferences']}');
    
    // 1. member_attributes_linkÏóêÏÑú Í∞ÄÏ†∏Ïò® Í∞úÏù∏ ÌäπÏÑ±/Ïä§ÌÉÄÏùº ÌÉúÍ∑∏
    final memberAttributes = profile['member_attributes'] as List<dynamic>? ?? [];
    print('üè∑Ô∏è [TAG DEBUG] Found ${memberAttributes.length} member_attributes');
    for (final attr in memberAttributes.take(4)) { // ÏµúÎåÄ 4Í∞ú Í∞úÏù∏ ÌäπÏÑ±
      if (attr['attributes'] != null) {
        final attributeData = attr['attributes'] as Map<String, dynamic>;
        final type = attributeData['type'] as String?;
        final name = attributeData['name'] as String?;
        
        // Í∞úÏù∏ ÌäπÏÑ±/Ïä§ÌÉÄÏùº Í¥ÄÎ†® ÌÉúÍ∑∏Îßå Ï∂îÍ∞Ä
        if (name != null && (type == 'MEMBER_STYLE' || type == 'JOB_ROLE')) {
          print('üè∑Ô∏è [TAG DEBUG] Adding attribute tag: $name ($type)');
          tags.add(name);
        }
      }
    }
    
    // 2. member_preferences_linkÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏÑ†Ìò∏ ÌÉúÍ∑∏  
    final memberPreferences = profile['member_preferences'] as List<dynamic>? ?? [];
    print('üè∑Ô∏è [TAG DEBUG] Found ${memberPreferences.length} member_preferences');
    for (final pref in memberPreferences.take(3)) { // ÏµúÎåÄ 3Í∞ú ÏÑ†Ìò∏ ÌÉúÍ∑∏
      if (pref['attributes'] != null) {
        final attributeData = pref['attributes'] as Map<String, dynamic>;
        final name = attributeData['name'] as String?;
        final type = attributeData['type'] as String?;
        
        // ÏÑ†Ìò∏ÎèÑ Í¥ÄÎ†® ÌÉúÍ∑∏Îßå Ï∂îÍ∞Ä
        if (name != null && (type == 'PLACE_FEATURE' || type == 'WELFARE')) {
          print('üè∑Ô∏è [TAG DEBUG] Adding preference tag: $name ($type)');
          tags.add(name);
        }
      }
    }
    
    // 3. ÏóÖÏ¢Ö ÌÉúÍ∑∏ (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ) - ÏµúÎåÄ 2Í∞ú
    final industries = profile['member_industries'] as List<dynamic>? ?? [];
    print('üè∑Ô∏è [TAG DEBUG] Found ${industries.length} member_industries');
    for (final industry in industries.take(2)) {
      if (industry['attributes'] != null && 
          industry['attributes']['type'] == 'INDUSTRY') {
        final industryName = industry['attributes']['name'] as String;
        print('üè∑Ô∏è [TAG DEBUG] Adding industry tag: $industryName');
        tags.add(industryName);
      }
    }
    
    // 4. Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ Îïå Í∏∞Î≥∏ Ï†ïÎ≥¥Î°ú ÌÉúÍ∑∏ ÏÉùÏÑ±
    if (tags.isEmpty) {
      final memberProfile = profileData['member_profile'] as Map<String, dynamic>? ?? {};
      
      // ÎÇòÏù¥ Ï†ïÎ≥¥
      final age = memberProfile['age'];
      if (age != null) {
        if (age >= 20 && age < 30) {
          tags.add('20ÎåÄ');
        } else if (age >= 30 && age < 40) {
          tags.add('30ÎåÄ');
        } else if (age >= 40) {
          tags.add('40ÎåÄ+');
        }
      }
      
      // Í≤ΩÎ†• Î†àÎ≤® Ï†ïÎ≥¥
      final experienceLevel = memberProfile['experience_level'] as String?;
      if (experienceLevel != null) {
        switch (experienceLevel) {
          case 'NEWCOMER':
          case 'NEWBIE':
            tags.add('Ïã†ÏûÖ');
            break;
          case 'JUNIOR':
            tags.add('Ï¥àÍ∏â');
            break;
          case 'INTERMEDIATE':
            tags.add('Ï§ëÍ∏â');
            break;
          case 'SENIOR':
            tags.add('Í≥†Í∏â');
            break;
          case 'EXPERT':
            tags.add('Ï†ÑÎ¨∏Í∞Ä');
            break;
        }
      }
      
      // ÏÑ±Î≥Ñ Ï†ïÎ≥¥
      final gender = memberProfile['gender'] as String?;
      if (gender == 'MALE') {
        tags.add('ÎÇ®ÏÑ±');
      } else if (gender == 'FEMALE') {
        tags.add('Ïó¨ÏÑ±');
      }
      
      // ÌÉúÍ∑∏Í∞Ä ÏóÜÏúºÎ©¥ ÌîÑÎ°úÌïÑ ÏóÜÏùåÏúºÎ°ú ÌëúÏãú
      if (tags.isEmpty) {
        tags.add('ÌîÑÎ°úÌïÑ ÏóÜÏùå');
      }
    }
    
    // fallback ÌÉúÍ∑∏ÎèÑ Ï†úÍ±∞ - Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏùÑ ÎïåÎßå ÌÉúÍ∑∏ ÌëúÏãú
    // if (tags.length < 3) {
    //   final fallbackTags = ['Î∞îÌÖêÎçî', 'ÏÑúÎπôÏä§ÌÉ≠', 'Í∏çÏ†ïÏ†Å', 'ÌåÄÏõåÌÅ¨', 'Ï±ÖÏûÑÍ∞êÏûàÎäî', 'ÏÜåÌÜµÏûòÌïòÎäî'];
    //   for (final fallback in fallbackTags) {
    //     if (!tags.contains(fallback) && tags.length < 8) {
    //       tags.add(fallback);
    //     }
    //   }
    // }
    
    print('üè∑Ô∏è [TAG DEBUG] Final generated tags: $tags');
    
    // ÌÉúÍ∑∏Í∞Ä ÎÑàÎ¨¥ ÎßéÏúºÎ©¥ ÏµúÎåÄ 8Í∞úÎ°ú Ï†úÌïú
    return tags.take(8).toList();
  }

  /// Generate place tags from profile data
  static List<String> _generatePlaceTagsFromProfile(Map<String, dynamic> profileData, Map<String, dynamic> profile) {
    List<String> tags = [];
    
    // Add place industries
    final industries = profile['place_industries'] as List<dynamic>? ?? [];
    for (final industry in industries.take(3)) {
      if (industry['attributes'] != null && 
          industry['attributes']['type'] == 'INDUSTRY') {
        tags.add(industry['attributes']['name'] as String);
      }
    }
    
    // Add manager gender
    if (profileData['manager_gender'] == 'Ïó¨') {
      tags.add('Ïó¨ÏÑ±ÏÇ¨Ïû•');
    } else if (profileData['manager_gender'] == 'ÎÇ®') {
      tags.add('ÎÇ®ÏÑ±ÏÇ¨Ïû•');  
    }
    
    // Add experience preference
    if (profileData['desired_experience_level']?.isNotEmpty == true) {
      tags.add('${_formatExperience(profileData['desired_experience_level'])} ÏÑ†Ìò∏');
    }
    
    return tags;
  }

  /// Send heart to a profile
  static Future<bool> sendHeart(String targetUserId, bool isMemberView) async {
    try {
      final response = await _supabase.functions.invoke(
        'hearts-manager',
        body: {
          'action': 'send',
          'targetUserId': targetUserId,
          'userType': isMemberView ? 'member' : 'place',
        },
      );

      return response.status == 200;
    } catch (e) {
      return false;
    }
  }

  /// Add profile to favorites
  static Future<bool> addToFavorites(String targetUserId, bool isMemberView, {String? notes}) async {
    try {
      final response = await _supabase.functions.invoke(
        'favorites-manager',
        body: {
          'action': 'add',
          'targetUserId': targetUserId,
          'userType': isMemberView ? 'member' : 'place',
          'notes': notes,
        },
      );

      return response.status == 200;
    } catch (e) {
      return false;
    }
  }

  /// Record pass action (for analytics)
  static Future<void> recordPassAction(String targetUserId, bool isMemberView) async {
    try {
      // Record pass in user_interactions table
      await _supabase.from('user_interactions').insert({
        'user_id': _supabase.auth.currentUser?.id,
        'target_user_id': targetUserId,
        'interaction_type': 'pass',
        'created_at': DateTime.now().toIso8601String(),
      });
    } catch (e) {
      // Silent fail for analytics
    }
  }

  /// Fallback method for direct database queries
  static Future<List<MatchProfile>> _getFallbackProfiles({
    required bool isMemberView,
    int limit = 20,
  }) async {
    if (isMemberView) {
      return await _getPlaceProfiles(limit: limit);
    } else {
      return await _getMemberProfiles(limit: limit);
    }
  }

  /// Get place profiles directly from database
  static Future<List<MatchProfile>> _getPlaceProfiles({int limit = 20}) async {
    final response = await _supabase
        .from('place_profiles')
        .select('''
          user_id,
          place_name,
          address,
          latitude,
          longitude,
          manager_gender,
          offered_min_pay,
          offered_max_pay,
          desired_experience_level,
          profile_image_urls,
          is_verified,
          is_premium,
          users!inner(email),
          place_industries(
            attribute_id,
            is_primary,
            attributes:attributes(
              name,
              type
            )
          )
        ''')
        .limit(limit);

    final profileFutures = response.map<Future<MatchProfile>>((data) async {
      final userId = data['user_id'];
      final heartsCount = await _getHeartsCount(userId, 'place');
      final favoritesCount = await _getFavoritesCount(userId, 'place');
      
      return MatchProfile(
        id: userId,
        name: data['place_name'] ?? 'Ïïå Ïàò ÏóÜÎäî ÏóÖÏ≤¥',
        subtitle: _formatIndustries(data['place_industries']),
        imageUrl: _getFirstImageUrl(data['profile_image_urls']),
        matchScore: _calculateMockScore(),
        location: _extractLocation(data['address']),
        distance: _calculateMockDistance(),
        payInfo: _formatPayInfo(data['offered_min_pay'], data['offered_max_pay']),
        schedule: _formatExperience(data['desired_experience_level']),
        tags: _generatePlaceTagsSync(data),
        type: ProfileType.place,
        isVerified: data['is_verified'] == true,
        isPremium: data['is_premium'] == true,
        heartsCount: heartsCount,
        favoritesCount: favoritesCount,
        industries: _extractIndustriesList(data['place_industries']),
      );
    });

    return await Future.wait(profileFutures);
  }

  /// Get member profiles directly from database
  static Future<List<MatchProfile>> _getMemberProfiles({int limit = 20}) async {
    final response = await _supabase
        .from('member_profiles')
        .select('''
          user_id,
          real_name,
          gender,
          age,
          experience_level,
          desired_pay_amount,
          desired_working_days,
          profile_image_urls,
          is_verified,
          is_premium,
          users!inner(email)
        ''')
        .limit(limit);

    final profileFutures = response.map<Future<MatchProfile>>((data) async {
      final userId = data['user_id'];
      final heartsCount = await _getHeartsCount(userId, 'member');
      final favoritesCount = await _getFavoritesCount(userId, 'member');
      
      return MatchProfile(
        id: userId,
        name: data['real_name'] ?? 'Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê',
        subtitle: _formatExperience(data['experience_level']),
        imageUrl: _getFirstImageUrl(data['profile_image_urls']),
        matchScore: _calculateMockScore(),
        location: 'ÏÑúÏö∏', // TODO: Ïã§Ï†ú ÏúÑÏπò Ï†ïÎ≥¥
        distance: _calculateMockDistance(),
        payInfo: (data['desired_pay_amount'] != null && data['desired_pay_amount'] > 0) 
            ? '${_formatPayType(data['desired_pay_type'])} ${_formatCurrency(data['desired_pay_amount'])}Ïõê'
            : 'Í∏âÏó¨ ÌòëÏùò',
        schedule: _formatMemberSchedule(data['desired_working_days']),
        tags: _generateMemberTagsSync(data),
        type: ProfileType.member,
        isVerified: data['is_verified'] == true,
        isPremium: data['is_premium'] == true,
        gender: data['gender'],
        heartsCount: heartsCount,
        favoritesCount: favoritesCount,
      );
    });

    return await Future.wait(profileFutures);
  }

  // Helper methods (unchanged from original)
  
  static String? _getFirstImageUrl(dynamic imageUrls) {
    if (imageUrls is List && imageUrls.isNotEmpty) {
      return imageUrls[0] as String?;
    }
    return null;
  }

  static String _extractLocation(String? address) {
    if (address == null || address.isEmpty) return 'ÏúÑÏπò Ï†ïÎ≥¥ ÏóÜÏùå';
    
    final parts = address.split(' ');
    if (parts.length >= 2) {
      return '${parts[0]} ${parts[1]}';
    }
    return address.length > 20 ? '${address.substring(0, 20)}...' : address;
  }

  static double _calculateDistanceFromCoords(double? lat, double? lng) {
    // TODO: Implement real distance calculation using user's current location
    // For now return mock distance
    return _calculateMockDistance();
  }

  static String _formatPayInfo(int? minPay, int? maxPay) {
    if (minPay == null && maxPay == null) return 'Í∏âÏó¨ ÌòëÏùò';
    if (minPay != null && maxPay != null) {
      return 'ÏãúÍ∏â ${_formatCurrency(minPay)}-${_formatCurrency(maxPay)}Ïõê';
    }
    if (minPay != null) return 'ÏãúÍ∏â ${_formatCurrency(minPay)}Ïõê Ïù¥ÏÉÅ';
    if (maxPay != null) return 'ÏãúÍ∏â ${_formatCurrency(maxPay)}Ïõê Ïù¥Ìïò';
    return 'Í∏âÏó¨ ÌòëÏùò';
  }

  static String _formatSchedule(Map<String, dynamic> profileData) {
    return profileData['business_hours'] ?? 'ÏãúÍ∞Ñ ÌòëÏùò';
  }

  static String _formatMemberSchedule(dynamic workingDays) {
    if (workingDays is List && workingDays.isNotEmpty) {
      return workingDays.join(', ');
    }
    return 'ÌòëÏùò Í∞ÄÎä•';
  }

  static String _formatCurrency(int amount) {
    return amount.toString().replaceAllMapped(
      RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
      (match) => '${match[1]},',
    );
  }

  static String _formatExperience(String? experience) {
    switch (experience) {
      case 'NEWCOMER': return 'Ïã†ÏûÖ';
      case 'JUNIOR': return 'Ï¥àÍ∏â';
      case 'INTERMEDIATE': return 'Ï§ëÍ∏â';
      case 'SENIOR': return 'Í≥†Í∏â';
      case 'EXPERT': return 'Ï†ÑÎ¨∏Í∞Ä';
      case 'NEWBIE': return 'Ïã†ÏûÖ';
      default: return 'Í≤ΩÎ†• ÎØ∏ÏÉÅ';
    }
  }

  /// Convert desired_pay_type to Korean
  static String _formatPayType(String? payType) {
    switch (payType) {
      case 'HOURLY': return 'Ìù¨ÎßùÏãúÍ∏â';
      case 'DAILY': return 'Ìù¨ÎßùÏùºÍ∏â';
      case 'WEEKLY': return 'Ìù¨ÎßùÏ£ºÍ∏â';
      case 'MONTHLY': return 'Ìù¨ÎßùÏõîÍ∏â';
      case 'ANNUAL': return 'Ìù¨ÎßùÏó∞Î¥â';
      case 'TC': return 'Ìù¨ÎßùÏãúÍ∏â'; // TC (Time Contract)
      case 'DC': return 'Ìù¨ÎßùÏùºÍ∏â'; // DC (Daily Contract)
      default: return 'Ìù¨ÎßùÏãúÍ∏â'; // Í∏∞Î≥∏Í∞í
    }
  }

  static List<String> _generatePlaceTagsSync(Map<String, dynamic> data) {
    List<String> tags = [];
    
    final industries = data['place_industries'] as List<dynamic>?;
    if (industries != null) {
      for (final industry in industries.take(3)) {
        if (industry['attributes'] != null && 
            industry['attributes']['type'] == 'INDUSTRY') {
          tags.add(industry['attributes']['name'] as String);
        }
      }
    }
    
    if (data['manager_gender'] == 'Ïó¨') {
      tags.add('Ïó¨ÏÑ±ÏÇ¨Ïû•');
    } else if (data['manager_gender'] == 'ÎÇ®') {
      tags.add('ÎÇ®ÏÑ±ÏÇ¨Ïû•');  
    }
    
    if (data['desired_experience_level']?.isNotEmpty == true) {
      tags.add('${_formatExperience(data['desired_experience_level'])} ÏÑ†Ìò∏');
    }
    
    return tags.isEmpty ? ['Ïã†ÏûÖÌôòÏòÅ', 'ÍµêÏú°ÏßÄÏõê', 'Î≥µÎ¶¨ÌõÑÏÉù'] : tags;
  }

  static List<String> _generateMemberTagsSync(Map<String, dynamic> data) {
    List<String> tags = [];
    
    if (data['experience_level']?.isNotEmpty == true) {
      tags.add(_formatExperience(data['experience_level']));
    }
    
    if (data['gender'] == 'FEMALE') {
      tags.add('Ïó¨ÏÑ±');
    } else if (data['gender'] == 'MALE') {
      tags.add('ÎÇ®ÏÑ±');
    }
    
    if (data['age'] != null) {
      final age = data['age'] as int;
      tags.add('${age}ÏÑ∏');
      if (age >= 20 && age < 30) {
        tags.add('20ÎåÄ');
      } else if (age >= 30 && age < 40) {
        tags.add('30ÎåÄ');
      }
    }
    
    return tags.isEmpty ? ['ÏÑ±Ïã§Ìï®', 'Ï±ÖÏûÑÍ∞ê', 'ÌåÄÏõåÌÅ¨'] : tags;
  }

  static int _calculateMockScore() {
    return 80 + (DateTime.now().millisecond % 20);
  }

  static double _calculateMockDistance() {
    return (DateTime.now().millisecond % 50) / 10.0;
  }
}